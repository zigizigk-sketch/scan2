<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Склад — Сканер</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Unbounded:wght@400;700&display=swap');
  :root {
    --bg:#0d0f14;--surface:#161a23;--border:#252b38;
    --accent-green:#00e676;--accent-red:#ff3d57;
    --accent-blue:#448aff;--accent-orange:#ff9100;
    --text:#e8ecf4;--muted:#5a6072;--radius:12px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
  header{padding:16px 20px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
  .logo{font-family:'Unbounded',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;color:var(--accent-blue);text-transform:uppercase}
  .status-dot{width:8px;height:8px;border-radius:50%;background:var(--accent-green);box-shadow:0 0 8px var(--accent-green);animation:pulse 2s infinite;margin-left:auto}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  .op-toggle{display:flex;margin:16px 16px 0;background:var(--surface);border-radius:var(--radius);padding:4px;border:1px solid var(--border)}
  .op-btn{flex:1;padding:12px;border:none;background:none;color:var(--muted);font-family:'Unbounded',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;border-radius:8px;cursor:pointer;transition:all .2s}
  .op-btn.active-receive{background:var(--accent-green);color:#000}
  .op-btn.active-ship{background:var(--accent-red);color:#fff}
  .form{flex:1;padding:16px;display:flex;flex-direction:column;gap:12px}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted)}
  input[type=text]{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;font-family:'JetBrains Mono',monospace;font-size:15px;color:var(--text);outline:none;transition:border-color .2s,box-shadow .2s;width:100%;-webkit-appearance:none}
  input[type=text]:focus{border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(68,138,255,.15)}
  input#barcode:focus{border-color:var(--accent-green);box-shadow:0 0 0 3px rgba(0,230,118,.15);font-size:18px;font-weight:600;letter-spacing:2px}
  /* Кнопка выбора полки */
  .shelf-btn{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;letter-spacing:3px;color:var(--muted);width:100%;text-align:left;cursor:pointer;transition:all .2s;display:flex;justify-content:space-between;align-items:center}
  .shelf-btn.selected{border-color:var(--accent-green);color:var(--text);box-shadow:0 0 0 3px rgba(0,230,118,.15)}
  .shelf-btn.error{border-color:var(--accent-red)}
  .shelf-arrow{font-size:12px;color:var(--muted);transition:transform .2s}
  .shelf-arrow.open{transform:rotate(180deg)}
  /* Дропдаун */
  .shelf-dropdown{display:none;background:var(--surface);border:1px solid var(--accent-blue);border-radius:var(--radius);overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.6);margin-top:4px}
  .shelf-dropdown.open{display:block}
  .dropdown-scroll{max-height:260px;overflow-y:auto}
  .dropdown-header{padding:8px 16px;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);background:rgba(0,0,0,.3);border-bottom:1px solid var(--border)}
  .dropdown-item{padding:13px 16px;font-size:14px;font-weight:700;letter-spacing:1px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);transition:background .15s}
  .dropdown-item:last-child{border-bottom:none}
  .dropdown-item.free{color:var(--accent-green)}
  .dropdown-item.free:hover{background:rgba(0,230,118,.08)}
  .dropdown-item.this-order{color:var(--accent-blue)}
  .dropdown-item.this-order:hover{background:rgba(68,138,255,.08)}
  .dropdown-item.w-zone{color:var(--accent-orange)}
  .dropdown-item.w-zone:hover{background:rgba(255,145,0,.08)}
  .dropdown-item.occupied{color:var(--muted);cursor:not-allowed;opacity:.4}
  .dbadge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;text-transform:uppercase;white-space:nowrap}
  .dbadge-free{background:rgba(0,230,118,.12);color:var(--accent-green)}
  .dbadge-order{background:rgba(68,138,255,.12);color:var(--accent-blue)}
  .dbadge-w{background:rgba(255,145,0,.12);color:var(--accent-orange)}
  .dbadge-occ{background:rgba(90,96,114,.12);color:var(--muted)}
  /* Инфо о заказе */
  .order-info{display:none;background:rgba(0,230,118,.06);border:1px solid rgba(0,230,118,.3);border-radius:var(--radius);padding:12px 16px;animation:fadeIn .3s ease}
  .order-info.show{display:block}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
  .order-info-title{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-green);margin-bottom:8px}
  .order-info-row{display:flex;justify-content:space-between;font-size:12px;padding:4px 0;border-bottom:1px solid var(--border)}
  .order-info-row:last-child{border-bottom:none}
  .order-info-key{color:var(--muted)}
  .order-info-val{color:var(--text);font-weight:600}
  .last-toggle{display:flex;background:var(--surface);border-radius:var(--radius);padding:4px;border:1px solid var(--border);gap:4px}
  .last-btn{flex:1;padding:16px;border:none;background:none;color:var(--muted);font-family:'Unbounded',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;border-radius:8px;cursor:pointer;transition:all .2s}
  .last-btn.active-no{background:var(--surface);color:var(--accent-green);border:1px solid var(--accent-green)}
  .last-btn.active-yes{background:var(--accent-orange);color:#000;box-shadow:0 0 14px rgba(255,145,0,.35)}
  .submit-btn{margin-top:4px;padding:18px;border:none;border-radius:var(--radius);font-family:'Unbounded',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all .2s}
  .submit-btn.receive{background:var(--accent-green);color:#000}
  .submit-btn.ship{background:var(--accent-red);color:#fff}
  .submit-btn:active{transform:scale(.98)}
  .submit-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 20px;font-size:13px;font-weight:600;white-space:nowrap;transition:transform .3s cubic-bezier(.34,1.56,.64,1);z-index:100;max-width:90vw}
  .toast.show{transform:translateX(-50%) translateY(0)}
  .toast.success{border-color:var(--accent-green);color:var(--accent-green)}
  .toast.error{border-color:var(--accent-red);color:var(--accent-red)}
  .toast.loading{border-color:var(--accent-blue);color:var(--accent-blue)}
  .toast.warn{border-color:var(--accent-orange);color:var(--accent-orange)}
  .log-section{margin:0 16px 16px;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
  .log-header{padding:10px 14px;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .log-clear{background:none;border:none;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer;text-decoration:underline}
  .log-items{max-height:180px;overflow-y:auto}
  .log-item{padding:10px 14px;font-size:11px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:flex-start;animation:slideIn .3s ease}
  @keyframes slideIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
  .log-item:last-child{border-bottom:none}
  .log-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;white-space:nowrap;flex-shrink:0}
  .log-badge.receive{background:rgba(0,230,118,.15);color:var(--accent-green)}
  .log-badge.ship{background:rgba(255,61,87,.15);color:var(--accent-red)}
  .log-last{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:rgba(255,145,0,.15);color:var(--accent-orange);white-space:nowrap;flex-shrink:0}
  .log-info{color:var(--text);line-height:1.6}
  .log-time{color:var(--muted);font-size:10px;margin-top:2px}
  .empty-log{padding:20px;text-align:center;color:var(--muted);font-size:11px}
  .settings-btn{background:none;border:1px solid var(--border);border-radius:8px;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:11px;padding:6px 12px;cursor:pointer;margin:0 16px 16px;width:calc(100% - 32px);transition:all .2s}
  .settings-panel{display:none;margin:0 16px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
  .settings-panel.open{display:block}
  .settings-panel label{margin-bottom:8px;display:block}
  .settings-panel input[type=text]{font-size:11px;padding:10px 12px}
  .settings-save{margin-top:10px;padding:10px;width:100%;background:var(--accent-blue);color:#fff;border:none;border-radius:8px;font-family:'Unbounded',sans-serif;font-size:11px;font-weight:700;cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="logo">⬡ WMS Scan</div>
  <div class="status-dot"></div>
</header>

<div class="op-toggle">
  <button class="op-btn active-receive" id="btnReceive" onclick="setOp('receive')">▼ Приёмка</button>
  <button class="op-btn" id="btnShip" onclick="setOp('ship')">▲ Отгрузка</button>
</div>

<div class="form">

  <div class="field">
    <label>Штрихкод</label>
    <input type="text" id="barcode" placeholder="Сканируй или введи вручную" autofocus autocomplete="off">
    <span style="font-size:10px;color:var(--muted);padding:2px 0 0 2px">← курсор должен быть здесь при сканировании</span>
  </div>

  <div class="order-info" id="orderInfo">
    <div class="order-info-title">ℹ Заказ найден в таблице</div>
    <div class="order-info-row"><span class="order-info-key">Номер заказа</span><span class="order-info-val" id="infoOrder">—</span></div>
    <div class="order-info-row"><span class="order-info-key">Год</span><span class="order-info-val" id="infoYear">—</span></div>
    <div class="order-info-row"><span class="order-info-key">Полки заказа</span><span class="order-info-val" id="infoShelves">—</span></div>
    <div class="order-info-row"><span class="order-info-key">Коробок принято</span><span class="order-info-val" id="infoCount">—</span></div>
  </div>

  <div class="field">
    <label>Полка</label>
    <button class="shelf-btn" id="shelfBtn" onclick="toggleDropdown()">
      <span id="shelfBtnText">Выбери полку ↓</span>
      <span class="shelf-arrow" id="shelfArrow">▼</span>
    </button>
    <div class="shelf-dropdown" id="shelfDropdown">
      <div class="dropdown-scroll" id="dropdownScroll"></div>
    </div>
  </div>

  <div class="field">
    <label>Последняя коробка?</label>
    <div class="last-toggle">
      <button class="last-btn active-no" id="btnNo" onclick="setLast(false)">✓ Не последняя</button>
      <button class="last-btn" id="btnYes" onclick="setLast(true)">⚠ Последняя</button>
    </div>
  </div>

  <button class="submit-btn receive" id="submitBtn" onclick="submitScan()">✓ Записать приёмку</button>
</div>

<div class="log-section">
  <div class="log-header">
    <span>Последние записи</span>
    <button class="log-clear" onclick="clearLog()">очистить</button>
  </div>
  <div class="log-items" id="logItems"><div class="empty-log">Записей пока нет</div></div>
</div>

<button class="settings-btn" onclick="toggleSettings()">⚙ Настройки</button>
<div class="settings-panel" id="settingsPanel">
  <div class="field">
    <label>Google Apps Script URL</label>
    <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
  </div>
  <div class="field" style="margin-top:10px">
    <label>Имя сотрудника</label>
    <input type="text" id="workerName" placeholder="Иванов И.">
  </div>
  <button class="settings-save" onclick="saveSettings()">Сохранить</button>
</div>

<div class="toast" id="toast"></div>

<script>
  let currentOp = 'receive';
  let isLast = false;
  let selectedShelf = '';
  let currentOrderData = null;
  let log = JSON.parse(localStorage.getItem('wms_log') || '[]');

  document.getElementById('scriptUrl').value = localStorage.getItem('wms_url') || '';
  document.getElementById('workerName').value = localStorage.getItem('wms_worker') || '';
  renderLog();

  function getAllShelves() {
    const s = [];
    'ABCDEFGHIJKLMNOPQ'.split('').forEach(l => { for(let n=1;n<=8;n++) s.push(l+n); });
    for(let n=1;n<=7;n++) s.push('W'+n);
    return s;
  }

  function renderDropdown() {
    const all = getAllShelves();
    const shelfToOrder = (currentOrderData && currentOrderData.shelfToOrder) || {};
    const orderShelves = (currentOrderData && currentOrderData.shelves) || [];
    const scroll = document.getElementById('dropdownScroll');

    const thisOrder=[], free=[], wZone=[], occupied=[];
    all.forEach(s => {
      if (s[0]==='W') { wZone.push(s); return; }
      if (orderShelves.includes(s)) { thisOrder.push(s); return; }
      if (!shelfToOrder[s]) { free.push(s); return; }
      occupied.push(s);
    });

    let html = '';

    if (thisOrder.length) {
      html += `<div class="dropdown-header">Полки этого заказа</div>`;
      thisOrder.forEach(s => {
        html += `<div class="dropdown-item this-order" onclick="selectShelf('${s}')"><span>${s}</span><span class="dbadge dbadge-order">этот заказ</span></div>`;
      });
    }

    html += `<div class="dropdown-header">Свободные (${free.length})</div>`;
    free.forEach(s => {
      html += `<div class="dropdown-item free" onclick="selectShelf('${s}')"><span>${s}</span><span class="dbadge dbadge-free">свободна</span></div>`;
    });

    html += `<div class="dropdown-header">Зона W — несколько заказов</div>`;
    wZone.forEach(s => {
      html += `<div class="dropdown-item w-zone" onclick="selectShelf('${s}')"><span>${s}</span><span class="dbadge dbadge-w">зона W</span></div>`;
    });

    if (occupied.length) {
      html += `<div class="dropdown-header">Занятые (${occupied.length})</div>`;
      occupied.forEach(s => {
        const who = shelfToOrder[s] || '?';
        html += `<div class="dropdown-item occupied"><span>${s}</span><span class="dbadge dbadge-occ">заказ ${who}</span></div>`;
      });
    }

    scroll.innerHTML = html;
  }

  function toggleDropdown() {
    const dd = document.getElementById('shelfDropdown');
    const arrow = document.getElementById('shelfArrow');
    const isOpen = dd.classList.contains('open');
    if (isOpen) {
      dd.classList.remove('open');
      arrow.classList.remove('open');
    } else {
      renderDropdown();
      dd.classList.add('open');
      arrow.classList.add('open');
    }
  }

  function closeDropdown() {
    document.getElementById('shelfDropdown').classList.remove('open');
    document.getElementById('shelfArrow').classList.remove('open');
  }

  function selectShelf(shelf) {
    selectedShelf = shelf;
    const btn = document.getElementById('shelfBtn');
    const txt = document.getElementById('shelfBtnText');
    txt.textContent = shelf;
    btn.classList.add('selected');
    btn.classList.remove('error');
    closeDropdown();
    showToast('success', '✓ Полка ' + shelf + ' выбрана');
  }

  // Закрыть при клике вне
  document.addEventListener('click', function(e) {
    const field = e.target.closest('.field');
    const dd = document.getElementById('shelfDropdown');
    if (dd.classList.contains('open') && !e.target.closest('#shelfBtn') && !e.target.closest('#shelfDropdown')) {
      closeDropdown();
    }
  });

  document.getElementById('barcode').addEventListener('keydown', function(e) {
    if (e.key==='Enter') { e.preventDefault(); const b=this.value.trim(); if(b) checkOrder(b); }
  });

  function checkOrder(barcode) {
    const url = localStorage.getItem('wms_url');
    if (!url) {
      renderDropdown();
      document.getElementById('shelfDropdown').classList.add('open');
      document.getElementById('shelfArrow').classList.add('open');
      showToast('warn', '⚠ URL не задан · выбери полку вручную');
      return;
    }
    showToast('loading', '⟳ Проверяю заказ...');
    const cbName = 'wms_cb_' + Date.now();
    const script = document.createElement('script');
    window[cbName] = function(data) {
      if (document.head.contains(script)) document.head.removeChild(script);
      delete window[cbName];
      currentOrderData = data;
      if (data.found) {
        document.getElementById('infoOrder').textContent = data.orderNum;
        document.getElementById('infoYear').textContent = data.year;
        document.getElementById('infoShelves').textContent = data.shelves.join(', ') || '—';
        document.getElementById('infoCount').textContent = data.count + ' шт.';
        document.getElementById('orderInfo').classList.add('show');
        showToast('success', '✓ Заказ найден · ' + data.count + ' коробок');
      } else {
        document.getElementById('orderInfo').classList.remove('show');
        showToast('success', '✓ Новый заказ · выбери полку');
      }
      renderDropdown();
      document.getElementById('shelfDropdown').classList.add('open');
      document.getElementById('shelfArrow').classList.add('open');
    };
    script.onerror = function() {
      if (document.head.contains(script)) document.head.removeChild(script);
      delete window[cbName];
      showToast('error', '✗ Нет связи с таблицей');
      renderDropdown();
      document.getElementById('shelfDropdown').classList.add('open');
      document.getElementById('shelfArrow').classList.add('open');
    };
    script.src = url + '?action=check&barcode=' + encodeURIComponent(barcode) + '&callback=' + cbName;
    document.head.appendChild(script);
  }

  async function submitScan() {
    const barcode = document.getElementById('barcode').value.trim();
    const url = localStorage.getItem('wms_url');
    const worker = localStorage.getItem('wms_worker') || '';

    if (!barcode) { showToast('error','⚠ Введи или отсканируй штрихкод'); document.getElementById('barcode').focus(); return; }
    if (!selectedShelf) {
      showToast('error','⚠ Выбери полку');
      document.getElementById('shelfBtn').classList.add('error');
      renderDropdown();
      document.getElementById('shelfDropdown').classList.add('open');
      document.getElementById('shelfArrow').classList.add('open');
      return;
    }

    const entry = {
      timestamp: new Date().toLocaleString('ru'),
      operation: currentOp==='receive'?'Приёмка':'Отгрузка',
      barcode, shelf: selectedShelf,
      isLast: isLast?'Да':'Нет', worker
    };

    if (!url) { addToLog(entry); showToast('success','✓ Сохранено локально'); resetForm(); return; }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true; showToast('loading','⟳ Отправляю...');
    try {
      await fetch(url, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(entry) });
      addToLog(entry); showToast('success','✓ Записано в таблицу!'); resetForm();
    } catch(err) { showToast('error','✗ Ошибка сети'); }
    finally { btn.disabled = false; }
  }

  function resetForm() {
    document.getElementById('barcode').value = '';
    selectedShelf = '';
    document.getElementById('shelfBtnText').textContent = 'Выбери полку ↓';
    document.getElementById('shelfBtn').classList.remove('selected','error');
    document.getElementById('orderInfo').classList.remove('show');
    closeDropdown();
    currentOrderData = null;
    document.getElementById('barcode').focus();
  }

  function setOp(op) {
    currentOp = op;
    document.getElementById('btnReceive').className='op-btn'+(op==='receive'?' active-receive':'');
    document.getElementById('btnShip').className='op-btn'+(op==='ship'?' active-ship':'');
    const btn = document.getElementById('submitBtn');
    btn.className='submit-btn '+(op==='receive'?'receive':'ship');
    btn.textContent=op==='receive'?'✓ Записать приёмку':'✓ Записать отгрузку';
  }

  function setLast(val) {
    isLast=val;
    document.getElementById('btnYes').className='last-btn'+(val?' active-yes':'');
    document.getElementById('btnNo').className='last-btn'+(!val?' active-no':'');
  }

  function addToLog(entry) {
    log.unshift(entry); if(log.length>50) log=log.slice(0,50);
    localStorage.setItem('wms_log',JSON.stringify(log)); renderLog();
  }

  function renderLog() {
    const el=document.getElementById('logItems');
    if(!log.length){el.innerHTML='<div class="empty-log">Записей пока нет</div>';return;}
    el.innerHTML=log.map(e=>`
      <div class="log-item">
        <span class="log-badge ${e.operation==='Приёмка'?'receive':'ship'}">${e.operation}</span>
        ${e.isLast==='Да'?'<span class="log-last">⚠ посл.</span>':''}
        <div>
          <div class="log-info">${e.barcode}${e.shelf?' · '+e.shelf:''}</div>
          <div class="log-time">${e.timestamp}${e.worker?' · '+e.worker:''}</div>
        </div>
      </div>`).join('');
  }

  function clearLog(){log=[];localStorage.removeItem('wms_log');renderLog();}

  function showToast(type,msg){
    const t=document.getElementById('toast');
    t.className=`toast ${type}`;t.textContent=msg;t.classList.add('show');
    clearTimeout(window._tt);window._tt=setTimeout(()=>t.classList.remove('show'),3500);
  }

  function toggleSettings(){document.getElementById('settingsPanel').classList.toggle('open');}

  function saveSettings(){
    localStorage.setItem('wms_url',document.getElementById('scriptUrl').value.trim());
    localStorage.setItem('wms_worker',document.getElementById('workerName').value.trim());
    document.getElementById('settingsPanel').classList.remove('open');
    showToast('success','✓ Настройки сохранены');
  }
</script>
</body>
</html>
